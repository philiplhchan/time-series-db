################################################################################
# Dockerfile.custom - Uses custom OpenSearch TAR with TSDB patches
# Based on OpenSearch's official Dockerfile structure
################################################################################

FROM almalinux:10 AS builder

# Install tini (init system for containers)
# Note: Using -k flag to bypass SSL verification for local testing
RUN set -eux ; \
    tini_bin="" ; \
    case "$(arch)" in \
        aarch64) tini_bin='tini-arm64' ;; \
        x86_64)  tini_bin='tini-amd64' ;; \
        *) echo >&2 ; echo >&2 "Unsupported architecture $(arch)" ; echo >&2 ; exit 1 ;; \
    esac ; \
    curl -k --retry 8 -S -L -O https://github.com/krallin/tini/releases/download/v0.19.0/${tini_bin} ; \
    curl -k --retry 8 -S -L -O https://github.com/krallin/tini/releases/download/v0.19.0/${tini_bin}.sha256sum ; \
    sha256sum -c ${tini_bin}.sha256sum ; \
    rm ${tini_bin}.sha256sum ; \
    mv ${tini_bin} /tini ; \
    chmod +x /tini

RUN mkdir /usr/share/opensearch
WORKDIR /usr/share/opensearch

# Copy custom OpenSearch TAR (with TSDB patches)
COPY build/distributions/opensearch-*.tar.gz /opt/opensearch.tar.gz

# Extract OpenSearch
RUN tar zxf /opt/opensearch.tar.gz --strip-components=1
RUN sed -i -e 's/OPENSEARCH_DISTRIBUTION_TYPE=tar/OPENSEARCH_DISTRIBUTION_TYPE=docker/' /usr/share/opensearch/bin/opensearch-env

# Copy TSDB plugin and telemetry-otel plugin
COPY build/distributions/tsdb-3.5.0.0-SNAPSHOT.zip /tmp/
COPY build/distributions/telemetry-otel-3.5.0-SNAPSHOT.zip /tmp/

# Install plugins
RUN /usr/share/opensearch/bin/opensearch-plugin install --batch file:///tmp/tsdb-3.5.0.0-SNAPSHOT.zip && \
    /usr/share/opensearch/bin/opensearch-plugin install --batch file:///tmp/telemetry-otel-3.5.0-SNAPSHOT.zip && \
    rm -f /tmp/tsdb-3.5.0.0-SNAPSHOT.zip /tmp/telemetry-otel-3.5.0-SNAPSHOT.zip || true

# Create required directories
RUN mkdir -p config config/jvm.options.d data logs
RUN chmod 0775 config config/jvm.options.d data logs

################################################################################
# Final image
################################################################################

FROM almalinux:10

ENV OPENSEARCH_CONTAINER true

# Install required packages
# Note: Using sslverify=false to bypass SSL verification for local testing
RUN set -e \
     && dnf -y update --setopt=sslverify=false \
     && dnf -y install --setopt=tsflags=nodocs --setopt=sslverify=false \
          nmap-ncat shadow-utils zip unzip \
     && dnf clean all \
     && rm -rf /var/cache/dnf

# Create opensearch user
RUN groupadd -g 1000 opensearch && \
    adduser -u 1000 -g 1000 -G 0 -d /usr/share/opensearch opensearch && \
    chmod 0775 /usr/share/opensearch && \
    chown -R 1000:0 /usr/share/opensearch

WORKDIR /usr/share/opensearch

# Copy OpenSearch with TSDB plugin from builder
COPY --from=builder --chown=1000:0 /usr/share/opensearch /usr/share/opensearch
COPY --from=builder --chown=0:0 /tini /tini

# Replace OpenJDK's built-in CA certificate keystore with the one from the OS
RUN ln -sf /etc/pki/ca-trust/extracted/java/cacerts /usr/share/opensearch/jdk/lib/security/cacerts

ENV PATH /usr/share/opensearch/bin:$PATH

# Set ownership
RUN find /usr/share/opensearch/jdk -type d -exec chmod 0755 '{}' \;

# Ensure that there are no files with setuid or setgid
RUN find / -xdev -perm -4000 -exec chmod ug-s {} + || true

USER opensearch

EXPOSE 9200 9300 9600

ENTRYPOINT ["/tini", "--", "/usr/share/opensearch/bin/opensearch"]
